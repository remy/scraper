<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8" />
    <title>Scraper Scripts</title>
    <base href="<%= baseHref %>" />
    <link rel="stylesheet" href="css/style.css?v=<%= appVersion %>" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css" />
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css" />
  </head>

  <body>
    <% if (message) { %>
      <p class="message">
        <%= escapeHtml(message) %>
      </p>
      <% } %>

        <div class="nav-controls">
          <button type="button" class="plain reload-button" id="reloadBtn" title="Reload">
            <img width="16" height="16" src="img/reload.svg" alt="" aria-hidden="true" />
          </button>
          <div class="mode-toggle">
            <button type="button" class="mode-button active" data-mode="endpoints">Endpoints</button>
            <button type="button" class="mode-button" data-mode="editor">Editor</button>
          </div>
        </div>

        <section class="panel" id="endpointsView">
          <header>
            <div>
              <h2>Available endpoints</h2>
              <p class="note">Call, edit, or manage your scripts.</p>
            </div>

            <form class="upload-inline" action="upload-file" method="post" enctype="multipart/form-data">
              <input type="file" id="endpointScriptFile" name="scriptFile" required accept=".mjs,.js" />
              <label for="endpointScriptFile">Drop new file (or click to select)</label>
              <button type="submit">Upload Now</button>
            </form>
          </header>
          <ul class="script-list" id="endpointList" data-api-base="<%= apiBasePath %>">
            <li class="endpoint-row">Loading scripts...</li>
          </ul>
        </section>

        <div class="help-section" id="helpSection">
          <p><strong>Getting started:</strong> Scripts are Node.js modules that receive a context object with
            <code>request</code>, <code>response</code>, <code>browser</code>, <code>cheerio</code>, and
            <code>hass</code> in the default
            export. Use the browser to automate web tasks with Puppeteer, parse HTML with Cheerio, or interact with Home
            Assistant.
          </p>
          <p><strong>Upload or create:</strong> Drag a script file above, or use the <strong>Editor</strong> tab to
            write and save scripts. See example scripts in the repo: <a
              href="https://github.com/remy/scraper/tree/main/scraper/example-scripts"
              target="_blank">example-scripts</a> directory for browser and Cheerio examples.</p>
          <p><strong>Home Assistant integration:</strong> When running in Home Assistant, the context includes a
            <code>hass</code> object with methods for state management:
            <code>getState(entityId)</code>, <code>setState(entityId, state, attributes)</code>,
            <code>getStates()</code>,
            <code>callService(domain, service, serviceData)</code>, and <code>getConfig()</code>.
          </p>
        </div>

        <div class="modal hidden" id="confirmModal" role="dialog" aria-modal="true">
          <div class="modal-content">
            <h3 id="confirmTitle">Confirm deletion</h3>
            <p id="confirmMessage">Are you sure?</p>
            <div class="modal-actions">
              <button type="button" class="secondary" id="cancelDeleteBtn">Cancel</button>
              <button type="button" class="danger" id="confirmDeleteBtn">Delete</button>
            </div>
          </div>
        </div>

        <div class="modal hidden" id="renameModal" role="dialog" aria-modal="true">
          <div class="modal-content">
            <h3 id="renameTitle">Rename script</h3>
            <p id="renameMessage">Update the file name (without extension).</p>
            <label for="renameInput">New name</label>
            <input type="text" id="renameInput" autocomplete="off" />
            <div class="modal-actions">
              <button type="button" class="secondary" id="cancelRenameBtn">Cancel</button>
              <button type="button" id="confirmRenameBtn">Rename</button>
            </div>
          </div>
        </div>

        <section class="panel editor-panel hidden" id="editorView">
          <!-- <h2>Create or Edit Script</h2> -->
          <form id="textScriptForm" action="upload-text" method="post">
            <div class="editor-grid">
              <div class="editor-grid-item script-name-area">
                <label for="textScriptName">Script name</label>
                <input type="text" id="textScriptName" name="scriptName" placeholder="my-script" required />
              </div>
              <div class="editor-grid-item editor-log-info dimmed" id="editorLogInfo">
                <div class="editor-actions editor-log-actions">
                  <button type="button" id="runScriptBtn" disabled>Run script</button>
                </div>
                <div id="editorLogPlaceholder" class="editor-log-placeholder">
                  Logs will appear here after you save and run this script.
                </div>
                <div id="editorLogDetails" class="editor-log-details hidden">
                  <div class="editor-log-meta endpoint-log-meta">
                    <span class="pill empty" id="editorLogStatus">No recent run</span>
                    <span class="log-time" id="editorLogTime"></span>
                  </div>
                  <pre id="editorLogBody" class="editor-log-body endpoint-log-body"></pre>
                </div>
              </div>
              <div class="editor-grid-item editor-content-area">
                <label for="scriptContent">Content</label>
                <textarea id="scriptContent" name="scriptContent" rows="14"
                  placeholder="// Paste your script or data here" required></textarea>
              </div>
              <div class="editor-grid-item editor-controls">
                <div class="editor-actions">
                  <button type="button" id="templateBtn" class="secondary">Insert template</button>
                  <button type="button" id="newScriptBtn" class="secondary">New script</button>
                  <button type="submit" id="saveScriptBtn">Save script</button>
                </div>
                <p class="status" id="statusMessage"></p>
              </div>
              <div class="editor-grid-item editor-tip">
                <p class="note">
                  Tip: This editor is great for quick tweaks, but editing files via
                  Samba/SSH at
                  <code>/addon_configs/&lt;repository&gt;_scraper/scripts</code>
                  gives you better tooling support. All scripts are saved with a
                  <code>.mjs</code> extension.
                </p>
              </div>
            </div>
          </form>

        </section>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
        <script
          src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
        <script
          src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closebrackets.min.js"></script>
        <script type="template" id="templateScript">
            <%- scriptTemplate %>
        </script>
        <script src="js/app.js?v=<%= appVersion %>" defer></script>
  </body>

</html>